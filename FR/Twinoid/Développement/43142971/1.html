<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>[Help] Script GM &gt; Flash quality="low"</title>
    <link href="../../../../gfx/game/Twinoid.ico" rel="icon" type="image/gif"/>
    <link href="../../../../css/twinoid_layout.css" rel="stylesheet" type="text/css"/>
    <link href="../../../../css/twinoid_bar.css" rel="stylesheet" type="text/css"/>
    <link href="../../../../css/custom.css" rel="stylesheet" type="text/css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.tid_niceHiddenNotice').click(function() {
                $(this).next('.tid_post').slideDown(500);
                $(this).slideUp(250);
            });
        });
    </script>
</head>
<body>
    <div id="contentBg">
        <div class="tid_forum_init" id="tid_forum">
            <div id="tid_forum_all"></div>
            <table class="tid_forumLayout">
                <tbody>
                    <tr>
                        <td id="tid_forum_right">
                            <div class="tid_containerWrapper">
                                <div class="tid_forumThread">
                                    <div class="tid_mainBar">
                                        <div class="tid_stack tid_bg4">
											<a class="tid_bg4" href="../../../Index.html" tid_href="left:">
												<img src="../../../../gfx/design/flag_FR.svg" style="width: 20px; height: 15px; vertical-align: middle;">
												Accueil
											</a>
                                            <a class="tid_bg4" href="../../Index.html" tid_href="left:">Twinoid</a>
                                            <a class="tid_bg4" href="../Index.html" tid_href="left:">Développement</a>
                                            <span class="tid_title">[Help] Script GM &gt; Flash quality="low"</span>
                                        </div>
                                        
                                    </div>
                                    <div class="tid_clear tid_threadStart"></div>
                                    <div class="tid_post tid_ tid_read" id="tid_forumPost_0">
    <div class="tid_header tid_bg1">
        <div class="tid_floatBox">
            <table class="tid_valign" style="width : 80px">
                <tbody>
                    <tr>
                        <td>
                            <div class="tid_twinoidAvatar" style="width:80px; max-height:80px; height:80px;">
                                <img src="..\..\..\..\gfx\avatars\twinoid_c_e_bb98eb58_8542_100x100.png" title="arcanmster" style="background-color: ; width: 80px;">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="tid_date">
            Le 17 décembre 2014
        </div>
        <div class="tid_name">
            <a class="tid_user tid_user_8542 tid_userNoBg tid_userFriend tid_parsed" href="//twinoid.com/user/go/8542/1" tid_id="8542">arcanmster</a>
        </div>
        <div class="tid_title">
            <span class="tid_userTitle"><img alt="[?]" src="..\..\..\..\gfx\icons\rwrd_cervelle.png" title=""/> H4ck3R au FJV</span>
        </div>
        <div class="tid_clearRight"></div>
    </div>
    <div class="tid_body tid_bg2">
        <div class="tid_arrow"></div>
        <div class="tid_originContent">
            <div class="tid_editorContent tid_parsed">
                <p>Probablement une question à la con, mais comme c'est pas du tout mon domaine de compétence...</p><br><p>Il y a quelques jours, l'une des fonctionnalités de mes scripts persos a cassé. GM sous Firefox. Bon ça arrive en général quand la MT fait un changement d'interface, mais ici ça concerne Odyssey donc peu de chances (haha) et en plus ça devrait être assez indépendant.</p><br><p>Le bout de code force simplement tout le flash Odyssey à passer en qualité réduite pour des raisons évidentes de je-ne-veux-pas-des-combats-lents-qui-durent-des-dizaines-de-minutes...</p><pre>var&nbsp;delay&nbsp;=&nbsp;GM_getValueDefaultInt('odyssey.loadDelay',&nbsp;1000);
GM_setValue('odyssey.loadDelay',&nbsp;delay);
setTimeout(&nbsp;function()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;omap&nbsp;=&nbsp;document.getElementById('map');
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(omap)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;omap.setAttribute('quality',&nbsp;'low');
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;par&nbsp;=&nbsp;omap.parentNode;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;par.removeChild(omap);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setTimeout(&nbsp;function()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;par.appendChild(omap);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},&nbsp;delay/2);
&nbsp;&nbsp;&nbsp;&nbsp;}
},&nbsp;delay);</pre><p>Ça doit faire depuis 2012 que j'utilise ça et jusqu'à récemment, ça fonctionnait très bien en pratique. Mais bon, je ne vois pas très bien où est la bêtise pour que ça casse soudainement (mise à jour Firefox ?). Y a quelque chose que je fais mal ? Ou une autre manière de procéder ?</p><br><p><em>char dasso; /* tanks */ </em></p><br><p><img src="../../../../gfx/square/calim.png" alt=":calim:" class="tid_ico"></p>
            </div>
        </div>
        <div class="tid_clear"></div>
    </div>
</div><div class="tid_post tid_ tid_read" id="tid_forumPost_1">
    <div class="tid_header tid_bg1">
        <div class="tid_floatBox">
            <table class="tid_valign" style="width : 80px">
                <tbody>
                    <tr>
                        <td>
                            <div class="tid_twinoidAvatar" style="width:80px; max-height:80px; height:80px;">
                                <img src="..\..\..\..\gfx\avatars\img_defaultAvatar.png" title="ayalti" style="background-color: rgb(204,171,82); width: 80px;">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="tid_date">
            Le 17 décembre 2014
        </div>
        <div class="tid_name">
            <a class="tid_user tid_user_36044 tid_userNoBg tid_userFriend tid_parsed" href="//twinoid.com/user/go/36044/1" tid_id="36044">ayalti</a>
        </div>
        <div class="tid_title">
            
        </div>
        <div class="tid_clearRight"></div>
    </div>
    <div class="tid_body tid_bg2">
        <div class="tid_arrow"></div>
        <div class="tid_originContent">
            <div class="tid_editorContent tid_parsed">
                <p>Je ne pige pas bien ce qu'est "delay" dans cette histoire. Juste un paramètre à toi que tu stockes en local storage pour te faire une idée du temps qu'il faut pour que ça soit prêt ?</p><p>En tous cas, ça fait deux trucs un peu soumis à de l'aléatoire :</p><ul><li>Si la map n'existe pas encore (j'ai pas vérifié ; mais je suppose qu'elle est créée après le chargement de la page, par du ajax quelconque ; sinon tu ne t'embêterais pas avec le setTimeout), alors ça foire. <br>&nbsp;<br>Or, ce n'est que ton "delay" à base d'expérience passée, je pense, qui te dis qu'elle existera. Il suffit de n'importe quoi qui rend le truc plus lent que prévu pour que ça foire. MAJ de firefox qui devient plus lent, par ex ; comme chaque MAJ de n'importe quel gros logiciel, qui devient de plus en plus lent au fur et à mesure que la pub affirme qu'il est de plus en plus performant^^. Idem pour flash. Ou même un changement au niveau des serveurs MT si c'est bien de l'ajax, donc dépendant du réseau. Genre une indirection de plus. Ce qui peut arriver même sans avoir touché à Odyssey.<br>&nbsp;<br>Si je pige bien, si ton setTimeout arrive trop tôt, tu ne fais rien pour réessayer (refaire un setTimeout "récursif", par exemple, dans le "else" de ton "if"<strong></strong>)</li></ul><ul><li>Idem pour le 2e setTimeout. Je suppose (jamais vérifié ça), que tu as besoin que #map soit vraiment viré de l'arbre DOM, l'arbre DOM rendu, bien réintégré pour que la modif soit prise en compte. Vu le modèle de JS (toute exécution de code est réputée atomique pour l'arbre DOM), c'est ce qui t'amènes sans doute à mettre un 2e setTimeout avant de le remettre. <br>Le problème, c'est que si le delay est trop petit, setTimeout(fn, delay) se comporte exactement comme fn(). Y compris de ce point de vue "exécution atomique". setTimeout(fn, 10) exécute fn() dans le même "thread" que l'appelant, dans le même appel atomique. En clair, il n'y aura pas de rendu de l'arbre DOM avant l'appel de fn. Et si fn refait qqc que j'ai défait, ça sera donc exactement comme s'il ne s'était rien passé du tout.<br>&nbsp;<br>Bon, l'évolution des puissances de calcul fait que normalement on ne s'attendant pas à ce qu'un delay qui autrefois était suffisant pour qu'il y ait bien une "2e exécution atomique", devienne insuffisant (c'est lié à la vitesse de la machine client). Mais sait-on jamais... En tous cas, le délai "delay/2" m'a l'air parfaitement arbitraire, et me laisse penser que tu n'as pas approfondi plus que ça cet aspect là.</li></ul><br><p>A part ça, j'ai pas vérifié le reste. Par exemple, je n'ai aucune idée sur la méthode "remove/append" de "map" pour (je suppose) forcer le truc à se réinitialiser.<br>Mais bon, ça ne ressemble pas à une méthode garantie par une norme. As-tu qqpart la garantie que l'exécution de map (donc du flash je suppose, et je ne connais rien à flash) est recommencée si on l'enlève de l'arbre DOM, même si le garbage collector ne le vire pas (puisqu'il reste une référence dessus via JS) ?<br>C'est peut-être un simple changement de comportement sur un aspect non normé.</p><p>Après tout j'ai lu récemment qu'il y avait un changement sur ce qui est "garbage collecté/référencé" avec les noeuds DOM (comme je ne m'amuse pas tellement à finasser là dessus, j'ai pas vraiment retenu de quoi il s'agissait. Je ne pense pas que ça ait de rapport ; mais ça illustre que certains trucs changent, sans pourtant discontinuer le respect de la norme)</p>
            </div>
        </div>
        <div class="tid_clear"></div>
    </div>
</div><div class="tid_post tid_ tid_read" id="tid_forumPost_2">
    <div class="tid_header tid_bg1">
        <div class="tid_floatBox">
            <table class="tid_valign" style="width : 80px">
                <tbody>
                    <tr>
                        <td>
                            <div class="tid_twinoidAvatar" style="width:80px; max-height:80px; height:80px;">
                                <img src="..\..\..\..\gfx\avatars\twinoid_e_0_73ed7b76_20333.jpg" title="Selliato" style="background-color: ; width: 80px;">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="tid_date">
            Le 17 décembre 2014
        </div>
        <div class="tid_name">
            <a class="tid_user tid_user_20333 tid_userNoBg tid_userFriend tid_parsed" href="//twinoid.com/user/go/20333/1" tid_id="20333">Selliato</a>
        </div>
        <div class="tid_title">
            <span class="tid_userTitle"><img alt="[?]" src="..\..\..\..\gfx\icons\fame.png" title=""/> Chef dÃ©corateur du Grand HÃ´tel</span>
        </div>
        <div class="tid_clearRight"></div>
    </div>
    <div class="tid_body tid_bg2">
        <div class="tid_arrow"></div>
        <div class="tid_originContent">
            <div class="tid_editorContent tid_parsed">
                <p>Après test, cela semble provenir des méthodes de GM,<br>Aucun code après ceux-ci n'est exécuté : si je les supprime complétement cela fonctionne, si j'utilise une seule des deux ça déconne de nouveau.</p><p>du coup cela fonctionne actuellement avec ça en script :</p><pre>var delay = 5000;
setTimeout( function() {
 var omap = document.getElementById('map');
 if (omap) {
 omap.setAttribute('quality', 'low');
 var par = omap.parentNode;
 par.removeChild(omap);
 setTimeout( function() {
 par.appendChild(omap);
 }, delay/2);
 }
}, delay);
</pre><p>( par contre je n'ai trouvé aucune doc sur la méthode "GM_getValueDefaultInt" qui donne d'ailleurs 0 résultats sur les moteurs de recherches ... question bête mais ... tu es sur qu'elle existe ? Elle est censée faire quoi de plus que GM_getValue ? )</p>
            </div>
        </div>
        <div class="tid_clear"></div>
    </div>
</div><div class="tid_post tid_ tid_read" id="tid_forumPost_3">
    <div class="tid_header tid_bg1">
        <div class="tid_floatBox">
            <table class="tid_valign" style="width : 80px">
                <tbody>
                    <tr>
                        <td>
                            <div class="tid_twinoidAvatar" style="width:80px; max-height:80px; height:80px;">
                                <img src="..\..\..\..\gfx\avatars\twinoid_3_6_5f5566f2_148_100x100.png" title="Bugzilla" style="background-color: ; width: 80px;">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="tid_date">
            Le 17 décembre 2014
        </div>
        <div class="tid_name">
            <a class="tid_user tid_user_148 tid_userNoBg tid_userFriend tid_parsed" href="//twinoid.com/user/go/148/1" tid_id="148">Bugzilla</a>
        </div>
        <div class="tid_title">
            <span class="tid_userTitle"><img alt="[?]" src="..\..\..\..\gfx\icons\Dark.png" title=""/> DivinitÃ© diabolique</span>
        </div>
        <div class="tid_clearRight"></div>
    </div>
    <div class="tid_body tid_bg2">
        <div class="tid_arrow"></div>
        <div class="tid_originContent">
            <div class="tid_editorContent tid_parsed">
                <p>As-tu bien ajouté les "@<span class="tid_strike"></span>grant" pour GM_setValue et GM_getValue ?</p><pre>// ==UserScript==
// @name ...
// @include ...
// @grant GM_getValue
// @grant GM_setValue
// ==/UserScript==
</pre><p>Si tu n'avais pas fait de mise à jour de Firefox et/ou Greasemonkey depuis environ un an (Firefox &lt; 30), tu avais peut-être encore une vieille version dans laquelle les "@<span class="tid_strike"></span>grant" n’étaient pas obligatoires dans l’en-tête.</p><p>Le modèle de sécurité a également changé récemment et ne permet plus d'utiliser "unsafeWindow" dans certain cas meme avec un "@<span class="tid_strike"></span>grant unsafeWindow", en particulier pour appeler des fonctions.</p><p>Tu peux aussi t'inspirer de <a target="_blank" href="https://greasyfork.org/en/scripts/3845-flash-quality-changer/code">ce script</a> pour les différents "@<span class="tid_strike"></span>grant"s.</p>
            </div>
        </div>
        <div class="tid_clear"></div>
    </div>
</div><div class="tid_post tid_ tid_read" id="tid_forumPost_4">
    <div class="tid_header tid_bg1">
        <div class="tid_floatBox">
            <table class="tid_valign" style="width : 80px">
                <tbody>
                    <tr>
                        <td>
                            <div class="tid_twinoidAvatar" style="width:80px; max-height:80px; height:80px;">
                                <img src="..\..\..\..\gfx\avatars\twinoid_e_0_73ed7b76_20333.jpg" title="Selliato" style="background-color: ; width: 80px;">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="tid_date">
            Le 17 décembre 2014
        </div>
        <div class="tid_name">
            <a class="tid_user tid_user_20333 tid_userNoBg tid_userFriend tid_parsed" href="//twinoid.com/user/go/20333/1" tid_id="20333">Selliato</a>
        </div>
        <div class="tid_title">
            <span class="tid_userTitle"><img alt="[?]" src="..\..\..\..\gfx\icons\fame.png" title=""/> Chef dÃ©corateur du Grand HÃ´tel</span>
        </div>
        <div class="tid_clearRight"></div>
    </div>
    <div class="tid_body tid_bg2">
        <div class="tid_arrow"></div>
        <div class="tid_originContent">
            <div class="tid_editorContent tid_parsed">
                <p>J'avais fait l'erreur d'oublier les "grant" pratique pour aider.</p><p>Du coup le script fonctionne chez moi avec dernière version de firefox et greasemonkey mais à condition de mettre ces grant et de remplacer "GM_getValueDefaultInt" par "GM_getValue". ( j'ai juste mis un délais plus important au vu de la vitesse de ma connexion )</p>
            </div>
        </div>
        <div class="tid_clear"></div>
    </div>
</div>
                                    <div id="tid_forumReplyForm" style="display: none"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>