<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>[Green Witch] Bug princier</title>
    <link href="../../../../gfx/game/Arkadeo.ico" rel="icon" type="image/gif"/>
    <link href="../../../../css/twinoid_layout.css" rel="stylesheet" type="text/css"/>
    <link href="../../../../css/twinoid_bar.css" rel="stylesheet" type="text/css"/>
    <link href="../../../../css/custom.css" rel="stylesheet" type="text/css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.tid_niceHiddenNotice').click(function() {
                $(this).next('.tid_post').slideDown(500);
                $(this).slideUp(250);
            });
        });
    </script>
</head>
<body>
    <div id="contentBg">
        <div class="tid_forum_init" id="tid_forum">
            <div id="tid_forum_all"></div>
            <table class="tid_forumLayout">
                <tbody>
                    <tr>
                        <td id="tid_forum_right">
                            <div class="tid_containerWrapper">
                                <div class="tid_forumThread">
                                    <div class="tid_mainBar">
                                        <div class="tid_stack tid_bg4">
											<a class="tid_bg4" href="../../../Index.html" tid_href="left:">
												<img src="../../../../gfx/design/flag_FR.svg" style="width: 20px; height: 15px; vertical-align: middle;">
												Accueil
											</a>
                                            <a class="tid_bg4" href="../../Index.html" tid_href="left:">Arkadeo</a>
                                            <a class="tid_bg4" href="../Index.html" tid_href="left:">Section Jeux</a>
                                            <span class="tid_title">[Green Witch] Bug princier</span>
                                        </div>
                                        
                                    </div>
                                    <div class="tid_clear tid_threadStart"></div>
                                    <div class="tid_post tid_ tid_read" id="tid_forumPost_0">
    <div class="tid_header tid_bg1">
        <div class="tid_floatBox">
            <table class="tid_valign" style="width : 80px">
                <tbody>
                    <tr>
                        <td>
                            <div class="tid_twinoidAvatar" style="width:80px; max-height:80px; height:80px;">
                                <img src="..\..\..\..\gfx\avatars\img_defaultAvatar.png" title="Spirou003" style="background-color: rgb(84,82,204); width: 80px;">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="tid_date">
            Le 21 août 2022
        </div>
        <div class="tid_name">
            <a class="tid_user tid_user_26161 tid_userNoBg tid_userFriend tid_parsed" href="//twinoid.com/user/go/26161/1" tid_id="26161">Spirou003</a>
        </div>
        <div class="tid_title">
            
        </div>
        <div class="tid_clearRight"></div>
    </div>
    <div class="tid_body tid_bg2">
        <div class="tid_arrow"></div>
        <div class="tid_originContent">
            <div class="tid_editorContent tid_parsed">
                <p>Salut,</p><p>Puisque le code source est désormais disponible, j'y ai jeté un oeil pour voir la raison du bug princier. Le replacement des princes se passe ici (fonction "<em>repopCivilians</em>", ligne 40) <a href="https://github.com/motion-twin/WebGamesArchives/blob/main/Arkadeo/games/greenWitch/src/mode/League.hx" target="_blank">https://github.com/motion-twin/WebGam...</a><br>Simple boucle où on ajoute les N princes tour à tour... ma foi pourquoi pas, même si d'avance ça me semble assez audacieux de partir du principe que chaque prince positionné sera compatible avec tous les suivants sans aucun souci, mais soit.<br>La partie de code intéressante se trouve dans <a href="https://github.com/motion-twin/WebGamesArchives/blob/main/Arkadeo/games/greenWitch/src/Level.hx" target="_blank">https://github.com/motion-twin/WebGam...</a><strong></strong>, fonction "<em>getMetaOnceFarFromOthers</em>" en ligne 628.<br>L'appel à "<em>getAllMetaPoints(k)</em>" semble grosso modo demander l'ensemble des position admissibles "au milieu" du plateau pour placer un prince (je ne suis pas rentré dans le détail de la construction de ce dernier), ceci étant un tableau de points. Ensuite dans la première boucle on supprime l'ensemble des positions déjà utilisées pour ne pas mettre deux princes au même endroit (ou sur le joueur par exemple) (cf <a href="https://api.haxe.org/Array.html#splice" target="_blank">https://api.haxe.org/Array.html#splice</a><strong></strong>).<br>Ensuite, on a une nouvelle boucle, dans laquelle on tente de positionner un prince suffisamment loin de tout le reste. Si cela marche tant mieux, sinon on réessaye en diminuant la distance du "suffisamment loin". Au bout d'un moment, on abandonne l'idée d'être suffisamment loin et on retourne simplement le dernier point qui a été considéré. Cela explique qu'à un moment, les princes puissent apparaître très rapprochés des autres.<br>Mais cela n'explique pas l'apparition par quelques gros paquets ni le crash. Relisons un peu le code. Ligne 645, est-on sûr que meta2 possède bien au moins un élément lorsque l'on fait le splice? Si cela n'est pas le cas, l'appel à "<em>rs.random(meta2.length)</em>" provoque en interne une division par zéro (tout comme le [0] derrière le splice provoque un accès hors tableau), mais oublions cela. Sous quelles conditions cela peut-il être vide? Si meta est trop petit puisque "<em>meta2 = meta.copy()</em>" (lignes 643 et 655). Relisons la définition de meta: "<em>getAllMetaPoints(k).copy()</em>", donc la source ne sera jamais altérée. Mais ensuite, on lui ôte tout ce qui est marqué comme utilisé (632 et 633). Que sait-on sur ce qui est utilisé? Recherchons les références à la variable "<em>used</em>":</p><ul><li>Ligne 73: déclaration</li><li>Ligne 98: initialisation</li><li>Ligne 558: assignation d'une case dans la fonction "<em>setUsed</em>"</li><li>Ligne 561: voir ce qui est dans la case via la fonction "<em>isUsed</em>"</li></ul><p>Parfait. Les seules écritures se font via la fonction "<em>setUsed</em>". Si l'on recherche les appels à cette fonction, on constate qu'ils sont tous faits en omettant le troisième paramètre, qui permet de décider de la valeur à placer dans le tableau (ce n'en est pas un, mais je le considère comme tel).</p><p><span class="tid_preRoleplay">Conclusion</span><span class="tid_roleplay"><span class="tid_wroleplay"></span></span></p><p>Au cours du jeu, les emplacements qui sont utilisés par un prince ne sont jamais libérés. Comme il y a un nombre limité d'emplacements calculés au début du jeu, cela signifie qu'au bout d'un moment il n'y a tout simplement plus suffisamment de places libres pour mettre la prochaine vague de princes.<br>Cela explique que le jeu crashe (vu la division par zéro entre autres ou l'accès hors d'un tableau vide) d'une part, et d'autre part cela explique que lorsque l'on a la chance de passer le premier bug princier, tous les princes soient agglomérés: il n'y a pas beaucoup d'autre(s) solution(s). On a donc bel et bien une limite de bonus princiers qui est déterminée par la map. Tout ceci rejoint <a target="_blank" href="http://arkadeo.com/r/fTmZ0M">ce que disais Vanitas</a>.</p><p>Ce bug pourrait être résolu très simplement en nettoyant "<em>used</em>" à la volée lors de la libération d'un prince. La fonction est même prévue pour, il n'y a plus qu'à l'utiliser!</p><p>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-<em></em>-</p><p>Je sais pas si quelqu'un lira, mais j'étais curieux de savoir pourquoi ça plantait alors autant partager mes "découvertes" <img src="../../../../gfx/square/cute.png" alt=":cute:" class="tid_ico"></p>
            </div>
        </div>
        <div class="tid_clear"></div>
    </div>
</div><div class="tid_post tid_ tid_read" id="tid_forumPost_1">
    <div class="tid_header tid_bg1">
        <div class="tid_floatBox">
            <table class="tid_valign" style="width : 80px">
                <tbody>
                    <tr>
                        <td>
                            <div class="tid_twinoidAvatar" style="width:80px; max-height:80px; height:80px;">
                                <img src="..\..\..\..\gfx\avatars\twinoid_e_0_723260e2_5872917_100x100.jpg" title="Anthrax" style="background-color: ; width: 80px;">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="tid_date">
            Le 27 août 2022
        </div>
        <div class="tid_name">
            <a class="tid_user tid_user_5872917 tid_userNoBg tid_userFriend tid_parsed" href="//twinoid.com/user/go/5872917/1" tid_id="5872917">Anthrax</a>
        </div>
        <div class="tid_title">
            <span class="tid_userTitle"><img alt="[?]" src="..\..\..\..\gfx\icons\l_emperor.png" title=""/> Empereur des Ã©toiles</span>
        </div>
        <div class="tid_clearRight"></div>
    </div>
    <div class="tid_body tid_bg2">
        <div class="tid_arrow"></div>
        <div class="tid_originContent">
            <div class="tid_editorContent tid_parsed">
                <p>Intéressant, même si je ne me rendrais jamais à ce niveau<img src="../../../../gfx/square/fear.png" alt=":fear:" class="tid_ico">.</p>
            </div>
        </div>
        <div class="tid_clear"></div>
    </div>
</div>
                                    <div id="tid_forumReplyForm" style="display: none"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>